<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Вариант 15 — Анализ изображения (RGB, SVG, инверсия)</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      background: #f0f2f5;
      color: #333;
      margin: 0;
    }
    h1 {
      font-size: 24px;
      margin-bottom: 10px;
      color: #2c3e50;
    }
    .row {
      display: flex;
      gap: 20px;
      align-items: flex-start;
      flex-wrap: wrap;
    }
    .panel {
      background: white;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      border: 1px solid #e1e5e9;
    }
    .controls {
      width: 350px;
      min-width: 300px;
    }
    .viewer {
      flex: 1;
      min-width: 500px;
    }
    svg {
      border: 1px solid #d1d9e6;
      border-radius: 6px;
      background: #fff;
      display: block;
    }
    .small {
      font-size: 14px;
      color: #555;
      margin: 5px 0;
    }
    input[type="file"] {
      display: block;
      margin: 10px 0;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      width: 100%;
    }
    hr {
      border: none;
      border-top: 1px solid #e1e5e9;
      margin: 15px 0;
    }
    ul {
      padding-left: 20px;
      margin: 10px 0;
    }
    li {
      margin: 8px 0;
      font-size: 14px;
    }
    strong {
      color: #2c3e50;
    }
    button {
      background: #3498db;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      margin-top: 10px;
      width: 100%;
    }
    button:hover {
      background: #2980b9;
    }
    .image-display {
      display: flex;
      gap: 20px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    .image-box {
      flex: 1;
      min-width: 300px;
    }
    .stats {
      background: #f8f9fa;
      padding: 10px;
      border-radius: 4px;
      margin-top: 10px;
      font-size: 13px;
    }
    .radio-group {
      margin: 15px 0;
    }
    .radio-label {
      display: flex;
      align-items: center;
      margin: 8px 0;
      cursor: pointer;
    }
    .radio-label input {
      margin-right: 8px;
    }
  </style>
</head>
<body>
  <div id="app">
    <h1>Вариант 15 — Анализ изображения (RGB, SVG, инверсия)</h1>
    <div class="row">
      <!-- Панель управления -->
      <div class="panel controls">
        <div class="small"><strong>Загрузить изображение (.jpg, .png)</strong></div>
        <input type="file" accept="image/*" @change="onFileChange" />
        <hr />
        <div class="small"><strong>Параметры варианта 15:</strong></div>
        <ul class="small">
          <li>Режим приложения: <strong>LSPWA</strong></li>
          <li>Цветовая модель: <strong>RGB</strong></li>
          <li>Объект графики: <strong>SVG</strong></li>
          <li>Гистограмма: <strong>Суммарная / Все каналы на одном</strong></li>
          <li>Оцифровка осей: <strong>нет</strong></li>
          <li>Нормализация: <strong>не требуется</strong></li>
          <li>Режим вывода: <strong>Цветовая инверсия</strong></li>
          <li>Построение гистограммы: <strong>Прямой (слева→направо)</strong></li>
        </ul>
        <hr />
        <div class="small"><strong>Режим гистограммы:</strong></div>
        <div class="radio-group">
          <label class="radio-label">
            <input type="radio" value="value" v-model="histogramMode" />
            Значение
          </label>
          <label class="radio-label">
            <input type="radio" value="color" v-model="histogramMode" />
            Цвет (RGB)
          </label>
        </div>
        <button @click="resetAll">Сбросить</button>
      </div>

      <!-- Панель просмотра -->
      <div class="panel viewer">
        <div class="image-display">
          <!-- Инвертированное изображение -->
          <div class="image-box">
            <div class="small">Инверсия (RGB)</div>
            <svg :width="displayWidth" :height="displayHeight">
              <rect x="0" y="0" :width="displayWidth" :height="displayHeight" fill="#f8f9fa" v-if="!imageLoaded" />
              <text x="10" y="20" fill="#777" v-if="!imageLoaded">Загрузите изображение</text>
              <image
                :href="invertedImageSrc"
                x="0" y="0"
                :width="displayWidth"
                :height="displayHeight"
                preserveAspectRatio="xMidYMid meet"
                v-if="imageLoaded"
              />
            </svg>
            <div class="stats" v-if="imageLoaded">
              Размер: {{ originalWidth }} × {{ originalHeight }} пикселей<br>
              Масштаб: {{ displayWidth }} × {{ displayHeight }} пикселей
            </div>
          </div>

          <!-- Гистограмма -->
          <div class="image-box">
            <div class="small">Гистограмма ({{ histogramMode === 'value' ? 'Суммарная яркость' : 'RGB-каналы' }}, SVG)</div>
            <svg :width="histogramWidth" :height="histogramHeight">
              <rect x="0" y="0" :width="histogramWidth" :height="histogramHeight" fill="#ffffff" />
              
              <!-- Режим "Значение" -->
              <g v-if="histogramMode === 'value' && histogramData.length">
                <rect
                  v-for="(item, idx) in histogramData"
                  :key="idx"
                  :x="idx * barWidth"
                  :y="histogramHeight - item.scaledAvg"
                  :width="barWidth - 0.5"
                  :height="item.scaledAvg"
                  fill="#3498db"
                  stroke="none"
                />
              </g>

              <!-- Режим "Цвет" -->
              <g v-else-if="histogramMode === 'color' && histogramData.length">
                <!-- Красный (R) -->
                <rect
                  v-for="(item, idx) in histogramData"
                  :key="'r-'+idx"
                  :x="idx * barWidth + 0.4"
                  :y="histogramHeight - item.scaledR"
                  :width="barWidth - 0.8"
                  :height="item.scaledR"
                  fill="red"
                  stroke="none"
                  opacity="0.7"
                />
                <!-- Зелёный (G) -->
                <rect
                  v-for="(item, idx) in histogramData"
                  :key="'g-'+idx"
                  :x="idx * barWidth + 0.2"
                  :y="histogramHeight - item.scaledG"
                  :width="barWidth - 0.8"
                  :height="item.scaledG"
                  fill="green"
                  stroke="none"
                  opacity="0.7"
                />
                <!-- Синий (B) -->
                <rect
                  v-for="(item, idx) in histogramData"
                  :key="'b-'+idx"
                  :x="idx * barWidth"
                  :y="histogramHeight - item.scaledB"
                  :width="barWidth - 0.8"
                  :height="item.scaledB"
                  fill="blue"
                  stroke="none"
                  opacity="0.7"
                />
              </g>

              <!-- Легенда (только в режиме "Цвет") -->
              <g v-if="histogramMode === 'color'">
                <rect x="420" y="10" width="12" height="12" fill="red" opacity="0.7"/>
                <text x="435" y="19" font-size="11" fill="#333">R</text>
                <rect x="420" y="28" width="12" height="12" fill="green" opacity="0.7"/>
                <text x="435" y="37" font-size="11" fill="#333">G</text>
                <rect x="420" y="46" width="12" height="12" fill="blue" opacity="0.7"/>
                <text x="435" y="55" font-size="11" fill="#333">B</text>
              </g>

              <text x="10" y="15" fill="#666" font-size="12">(прямой: 0 → 255)</text>
            </svg>
            <div class="stats" v-if="histogramData.length">
              Макс. значение: {{ maxHistogramValue }}<br>
              Средний индекс: {{ meanIndex }}<br>
              Всего пикселей: {{ totalPixels }}
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <script>
    const { createApp, ref } = Vue;

    createApp({
      setup() {
        const invertedImageSrc = ref('');
        const imageLoaded = ref(false);
        const histogramData = ref([]);
        const maxHistogramValue = ref(0);
        const meanIndex = ref(0);
        const originalWidth = ref(0);
        const originalHeight = ref(0);
        const displayWidth = ref(320);
        const displayHeight = ref(240);
        const histogramWidth = ref(512);
        const histogramHeight = ref(200);
        const barWidth = ref(2);
        const totalPixels = ref(0);
        const histogramMode = ref('value'); // 'value' или 'color'

        const onFileChange = (event) => {
          const file = event.target.files[0];
          if (!file) return;
          const url = URL.createObjectURL(file);
          loadImage(url);
        };

        const loadImage = (url) => {
          const img = new Image();
          img.onload = () => {
            originalWidth.value = img.width;
            originalHeight.value = img.height;

            const maxW = 320, maxH = 240;
            const scale = Math.min(maxW / img.width, maxH / img.height, 1);
            displayWidth.value = Math.round(img.width * scale);
            displayHeight.value = Math.round(img.height * scale);

            const canvas = document.createElement('canvas');
            canvas.width = img.width;
            canvas.height = img.height;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0);

            invertImage(ctx, canvas);
            analyzeImage(canvas);
          };
          img.src = url;
        };

        const invertImage = (ctx, canvas) => {
          const imgData = ctx.getImageData(0, 0, canvas.width, canvas.height);
          for (let i = 0; i < imgData.data.length; i += 4) {
            imgData.data[i]     = 255 - imgData.data[i];     // R
            imgData.data[i + 1] = 255 - imgData.data[i + 1]; // G
            imgData.data[i + 2] = 255 - imgData.data[i + 2]; // B
          }
          ctx.putImageData(imgData, 0, 0);
          invertedImageSrc.value = canvas.toDataURL('image/png');
          imageLoaded.value = true;
        };

        const analyzeImage = (canvas) => {
          const ctx = canvas.getContext('2d');
          const imgData = ctx.getImageData(0, 0, canvas.width, canvas.height).data;
          computeRGBHistogram(imgData);
        };

        const computeRGBHistogram = (imgData) => {
          const binsR = new Array(256).fill(0);
          const binsG = new Array(256).fill(0);
          const binsB = new Array(256).fill(0);
          const binsAvg = new Array(256).fill(0);

          totalPixels.value = imgData.length / 4;

          for (let i = 0; i < imgData.length; i += 4) {
            const r = imgData[i];
            const g = imgData[i + 1];
            const b = imgData[i + 2];
            const avg = Math.round((r + g + b) / 3);

            binsR[r]++;
            binsG[g]++;
            binsB[b]++;
            binsAvg[avg]++;
          }

          const maxR = Math.max(...binsR);
          const maxG = Math.max(...binsG);
          const maxB = Math.max(...binsB);
          const maxAvg = Math.max(...binsAvg);
          maxHistogramValue.value = maxAvg;

          let totalWeight = 0;
          let totalIndex = 0;
          for (let i = 0; i < 256; i++) {
            totalWeight += binsAvg[i];
            totalIndex += binsAvg[i] * i;
          }
          meanIndex.value = totalWeight ? Math.round(totalIndex / totalWeight) : 0;

          const scaled = binsAvg.map((_, i) => ({
            scaledAvg: maxAvg ? Math.round((binsAvg[i] / maxAvg) * (histogramHeight.value - 4)) : 0,
            scaledR:   maxR   ? Math.round((binsR[i] / maxR) * (histogramHeight.value - 4)) : 0,
            scaledG:   maxG   ? Math.round((binsG[i] / maxG) * (histogramHeight.value - 4)) : 0,
            scaledB:   maxB   ? Math.round((binsB[i] / maxB) * (histogramHeight.value - 4)) : 0
          }));

          histogramData.value = scaled;
          barWidth.value = Math.max(1, Math.floor(histogramWidth.value / 256));
        };

        const resetAll = () => {
          invertedImageSrc.value = '';
          imageLoaded.value = false;
          histogramData.value = [];
          maxHistogramValue.value = 0;
          meanIndex.value = 0;
          originalWidth.value = 0;
          originalHeight.value = 0;
          totalPixels.value = 0;
          histogramMode.value = 'value';
        };

        return {
          invertedImageSrc,
          imageLoaded,
          histogramData,
          maxHistogramValue,
          meanIndex,
          originalWidth,
          originalHeight,
          displayWidth,
          displayHeight,
          histogramWidth,
          histogramHeight,
          barWidth,
          totalPixels,
          histogramMode,
          onFileChange,
          resetAll
        };
      }
    }).mount('#app');
  </script>
</body>
</html>
